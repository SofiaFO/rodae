// schema.prisma
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// =====================
// Usuários
// =====================
model Usuario {
  id        Int       @id @default(autoincrement())
  nome      String    @db.VarChar(100)
  email     String    @unique
  telefone  String
  senha     String
  tipo      UsuarioTipo
  status    UsuarioStatus @default(PENDENTE)
  criadoEm  DateTime  @default(now())

  passageiro Passageiro?
  motorista  Motorista?
  corridasAsPassageiro Corrida[] @relation("CorridasPassageiro")
  corridasAsMotorista Corrida[] @relation("CorridasMotorista")
  avaliacoesFeitas Avaliacao[] @relation("AvaliacoesFeitas")
  avaliacoesRecebidas Avaliacao[] @relation("AvaliacoesRecebidas")
  notificacoes   Notificacao[]
}

enum UsuarioTipo {
  PASSAGEIRO
  MOTORISTA
  ADMIN
}

enum UsuarioStatus {
  ATIVO
  INATIVO
  PENDENTE
}

// =====================
// Passageiro (dados específicos)
// =====================
model Passageiro {
  id          Int       @id
  usuario     Usuario   @relation(fields: [id], references: [id], onDelete: Cascade)
  metodosPagamento MetodoPagamento[]
}

// =====================
// Motorista (dados específicos)
// =====================
model Motorista {
  id            Int       @id
  usuario       Usuario   @relation(fields: [id], references: [id], onDelete: Cascade)
  cnh           String    @unique
  validadeCNH   DateTime
  docVeiculo    String
  placaVeiculo  String    @unique
  modeloCorVeiculo String
}

// =====================
// Corridas
// =====================
model Corrida {
  id            Int        @id @default(autoincrement())
  passageiro    Usuario    @relation("CorridasPassageiro", fields: [passageiroId], references: [id])
  passageiroId  Int
  motorista     Usuario?   @relation("CorridasMotorista", fields: [motoristaId], references: [id])
  motoristaId   Int?
  origem        String
  destino       String
  formaPagamento FormaPagamento
  opcaoCorrida   OpcaoCorrida
  status        CorridaStatus @default(EM_ANDAMENTO)
  valorEstimado Float
  criadoEm      DateTime      @default(now())
  atualizadoEm  DateTime      @updatedAt

  pagamento     Pagamento?
  avaliacoes    Avaliacao[]
}

enum FormaPagamento {
  PIX
  CARTAO_CREDITO
  CARTEIRA_DIGITAL
}

enum OpcaoCorrida {
  PADRAO
  PREMIUM
  COMPARTILHADA
}

enum CorridaStatus {
  EM_ANDAMENTO
  FINALIZADA
  CANCELADA
}

// =====================
// Pagamentos
// =====================
model Pagamento {
  id          Int         @id @default(autoincrement())
  corrida     Corrida     @relation(fields: [corridaId], references: [id])
  corridaId   Int         @unique
  valor       Float
  forma       FormaPagamento
  status      PagamentoStatus @default(PENDENTE)
  criadoEm    DateTime    @default(now())
  atualizadoEm DateTime   @updatedAt
}

enum PagamentoStatus {
  PENDENTE
  PAGO
  FALHOU
  ESTORNADO
}

// =====================
// Avaliações
// =====================
model Avaliacao {
  id          Int       @id @default(autoincrement())
  corrida     Corrida   @relation(fields: [corridaId], references: [id])
  corridaId   Int
  nota        Int
  comentario  String?   @db.VarChar(200)
  usuarioDe   Usuario   @relation("AvaliacoesFeitas", fields: [usuarioDeId], references: [id])
  usuarioDeId Int
  usuarioPara Usuario   @relation("AvaliacoesRecebidas", fields: [usuarioParaId], references: [id])
  usuarioParaId Int
  criadoEm    DateTime  @default(now())
  atualizadoEm DateTime @updatedAt
  deletadoEm  DateTime?
  justificativaExclusao String?
  historicoEdicoes AvaliacaoHistorico[]

  @@unique([corridaId, usuarioDeId])
}

model AvaliacaoHistorico {
  id          Int       @id @default(autoincrement())
  avaliacao   Avaliacao @relation(fields: [avaliacaoId], references: [id])
  avaliacaoId Int
  notaAnterior Int
  comentarioAnterior String?
  notaNova    Int
  comentarioNovo String?
  editadoEm   DateTime  @default(now())
}

// =====================
// Notificações
// =====================
model Notificacao {
  id          Int       @id @default(autoincrement())
  usuario     Usuario   @relation(fields: [usuarioId], references: [id])
  usuarioId   Int
  tipo        TipoNotificacao
  mensagem    String
  lida        Boolean   @default(false)
  criadoEm    DateTime  @default(now())
}

enum TipoNotificacao {
  CORRIDA_ACEITA
  MOTORISTA_A_CAMINHO
  CORRIDA_FINALIZADA
  PAGAMENTO_CONFIRMADO
  PROMOCAO
}

// =====================
// Métodos de Pagamento do Passageiro
// =====================
model MetodoPagamento {
  id              Int       @id @default(autoincrement())
  passageiro      Passageiro @relation(fields: [passageiroId], references: [id], onDelete: Cascade)
  passageiroId    Int
  tipoPagamento   TipoPagamento
  nomeCartao      String?   @db.VarChar(60)
  numeroCartaoCriptografado String?
  validadeCartao  String?   // Formato: MM/AA (ex: 12/25)
  status          MetodoPagamentoStatus @default(ATIVO)
  criadoEm        DateTime  @default(now())
  atualizadoEm    DateTime  @updatedAt

  @@index([passageiroId])
}

enum TipoPagamento {
  CARTAO_CREDITO
  PIX
  CARTEIRA_APP
}

enum MetodoPagamentoStatus {
  ATIVO
  EXPIRADO
  INATIVO
}
